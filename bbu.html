<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>S∆° ƒë·ªì BBU (Debug)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    h2 { text-align: center; margin-bottom: 10px; }
    .bbu-container {
      display: flex;
      flex-wrap: wrap;
      width: 600px;
      margin: 0 auto;
      border: 3px solid #333;
      border-radius: 10px;
      padding: 10px;
      background: white;
    }
    .slot { flex: 1 0 30%; margin: 5px; padding: 10px; border: 2px solid #007bff; border-radius: 6px; text-align: center; background: #e9f3ff; font-size: 14px; }
    .highlight { background: #ffeb3b !important; border-color: #ff9800 !important; font-weight: bold; }
    .rru-container { margin-top: 20px; text-align: center; }
    .rru { display: inline-block; padding: 8px 12px; margin: 5px; border: 2px solid #4caf50; border-radius: 6px; background: #e8f5e9; font-size: 14px; }
    #debug { margin: 12px auto; max-width: 900px; background: #fff; border: 1px dashed #ccc; padding: 10px; font-size: 13px; white-space: pre-wrap; }
    #back { margin-top: 10px; display:block; }
  </style>
</head>
<body>
  <h2>üì° S∆° ƒë·ªì BBU 8200 ‚Äî Debug</h2>

  <div id="debug">ƒêang ƒë·ªçc d·ªØ li·ªáu...</div>

  <div class="bbu-container" id="bbu"></div>
  <div class="rru-container" id="rrus"></div>

  <button id="back">‚èÆ Quay l·∫°i trang t√¨m ki·∫øm</button>

  <script>
    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function logDebug(msg) {
      console.log(msg);
      const el = document.getElementById('debug');
      el.textContent += "\n" + msg;
    }

    function renderBBU(devices, highlightLabel) {
      const bbuSlots = ["PM", "SA", "FS", "CCC", "BPN2", "BPK_d"];
      const container = document.getElementById("bbu");
      container.innerHTML = "";

      bbuSlots.forEach(slot => {
        const match = devices.find(d => String(d["Unit Position"] || "").includes(slot));
        const div = document.createElement("div");
        div.className = "slot";
        div.innerText = match ? (match["User Label"] || slot) : slot;
        if (match && match["User Label"] === highlightLabel) div.classList.add("highlight");
        container.appendChild(div);
      });

      // RRUs
      const rruDiv = document.getElementById("rrus");
      rruDiv.innerHTML = "";
      const rrulist = devices.filter(d => /S\d+|\d{2}/.test(String(d["User Label"] || "")));
      if (rrulist.length) {
        const h = document.createElement("h3");
        h.innerText = "RRUs";
        rruDiv.appendChild(h);
        rrulist.forEach(r => {
          const el = document.createElement("div");
          el.className = "rru";
          el.innerText = r["User Label"];
          if (r["User Label"] === highlightLabel) el.classList.add("highlight");
          rruDiv.appendChild(el);
        });
      }
    }

    async function tryLoadDevices() {
      const debugEl = document.getElementById('debug');
      debugEl.textContent = "ƒêang ki·ªÉm tra storage...";

      // 1) th·ª≠ localStorage
      let raw = null;
      try {
        raw = localStorage.getItem('devices');
        if (raw) {
          logDebug("T√¨m th·∫•y localStorage 'devices' (" + raw.length + " chars)");
          const devices = JSON.parse(raw);
          return devices;
        }
      } catch (e) {
        logDebug("Kh√¥ng th·ªÉ parse localStorage 'devices': " + e);
      }

      // 2) th·ª≠ sessionStorage
      try {
        raw = sessionStorage.getItem('devices');
        if (raw) {
          logDebug("T√¨m th·∫•y sessionStorage 'devices' (" + raw.length + " chars)");
          const devices = JSON.parse(raw);
          return devices;
        }
      } catch (e) {
        logDebug("Kh√¥ng th·ªÉ parse sessionStorage 'devices': " + e);
      }

      // 3) th·ª≠ devices_fallback
      try {
        raw = localStorage.getItem('devices_fallback');
        if (raw) {
          logDebug("T√¨m th·∫•y localStorage 'devices_fallback'");
          const devices = JSON.parse(raw);
          return devices;
        }
      } catch (e) {
        logDebug("Kh√¥ng th·ªÉ parse devices_fallback: " + e);
      }

      // 4) fallback: fetch inventory.xlsx (n·∫øu ch·∫°y qua HTTP)
      try {
        logDebug("Kh√¥ng t√¨m th·∫•y storage. Th·ª≠ fetch 'inventory.xlsx' (ch·ªâ ho·∫°t ƒë·ªông khi ch·∫°y b·∫±ng HTTP server).");
        const resp = await fetch('inventory.xlsx');
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const buf = await resp.arrayBuffer();
        const wb = XLSX.read(buf, { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const devices = XLSX.utils.sheet_to_json(sheet);
        logDebug("ƒê√£ load t·ª´ inventory.xlsx: " + devices.length + " d√≤ng");
        return devices;
      } catch (e) {
        logDebug("Kh√¥ng th·ªÉ fetch inventory.xlsx: " + e.message);
      }

      // kh√¥ng t√¨m ƒë∆∞·ª£c g√¨
      return [];
    }

    (async function main(){
      const label = getParam('label');
      document.getElementById('debug').textContent = "Param label = " + label;
      const devices = await tryLoadDevices();
      logDebug("Devices count = " + (devices && devices.length ? devices.length : 0));
      if (!devices || devices.length === 0) {
        logDebug("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã. H√£y m·ªü hw.html v√† click 1 d√≤ng ƒë·ªÉ l∆∞u d·ªØ li·ªáu v√†o storage.");
        return;
      }
      renderBBU(devices, label);
      logDebug("ƒê√£ render BBU. Highlight label = " + label);
    })();

    document.getElementById('back').addEventListener('click', () => {
      window.location.href = 'hw.html';
    });
  </script>
</body>
</html>