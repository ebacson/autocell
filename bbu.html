<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üì° S∆° ƒë·ªì BBU 8200</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    h2 { text-align: center; margin-bottom: 12px; }

    /* BBU layout */
    .bbu {
      display: grid;
      grid-template-columns: 1fr 2fr 2fr 1fr; /* col1 nh·ªè, col2-3 l·ªõn, col4 nh·ªè */
      grid-template-rows: repeat(4, 90px);   /* 4 h√†ng */
      gap: 8px;
      max-width: 1000px;
      margin: 0 auto 20px;
      background: #fff;
      padding: 18px;
      border: 3px solid #333;
      border-radius: 10px;
      box-sizing: border-box;
    }
    .slot {
      border: 2px solid #007bff;
      border-radius: 6px;
      background: #e9f3ff;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      white-space: pre-line;
      overflow: hidden;
      padding: 6px;
      box-sizing: border-box;
    }
    .slot .slot-content { width: 100%; text-align: center; }
    .slot.s16 .slot-content { width: 50%; margin: 0 auto; } /* slot16 ƒë·∫∑c bi·ªát */
    .highlight {
      background: #ffeb3b !important;
      border-color: #ff9800 !important;
      font-weight: bold;
    }

    .rru-container { margin-top: 30px; text-align: center; }
    .rru-sector { margin-bottom: 15px; }
    .rru-sector h4 { margin: 5px 0; }
    .rru {
      display: inline-block;
      padding: 8px 12px;
      margin: 5px;
      border: 2px solid #4caf50;
      border-radius: 6px;
      background: #e8f5e9;
      font-size: 14px;
    }
    .rru.highlight {
      background: #c8e6c9;
      border-color: #2e7d32;
      font-weight: bold;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; font-size: 13px; }
    th { background: #007bff; color: white; }
    tr:nth-child(even) { background: #f9f9f9; }

    @media (max-width: 720px) {
      .bbu { grid-template-rows: repeat(8, 70px); grid-template-columns: 1fr 1fr; }
      .slot.s16 { grid-column: 2; grid-row: 1 / span 4; }
    }
  </style>
</head>
<body>
  <h2>üì° S∆° ƒë·ªì BBU 8200</h2>
  <div id="bbu" class="bbu" aria-label="BBU layout"></div>
  <div class="rru-container" id="rrus"></div>
  <div id="deviceTable"></div>

  <script>
    function getParam(name) {
      try { return new URL(window.location.href).searchParams.get(name); }
      catch { return null; }
    }

    function parseUnitPosition(unitPos) {
      const obj = { rack: "", shelf: "", slot: "" };
      if (!unitPos) return obj;
      unitPos.split(',').forEach(p => {
        const [key, ...vals] = p.split('=');
        if (key && vals.length) obj[key.trim().toLowerCase()] = vals.join('=').trim();
      });
      return obj;
    }

    // v·ªã tr√≠ slot
    const slotPositions = {
      '15': { col: 1, row: 2 },
      '14': { col: 1, row: 3 },
      '13': { col: 1, row: 4 },
      '4':  { col: 2, row: 1 },
      '3':  { col: 2, row: 2 },
      '2':  { col: 2, row: 3 },
      '1':  { col: 2, row: 4 },
      '8':  { col: 3, row: 1 },
      '7':  { col: 3, row: 2 },
      '6':  { col: 3, row: 3 },
      '5':  { col: 3, row: 4 },
      '16': { col: 4, row: 1, rowspan: 4 }
    };

    function renderBBU(allDevices, label) {
      const devices = allDevices.filter(d =>
        String(d["User Label"] || "").trim() === label &&
        parseUnitPosition(d["Unit Position"]).rack === "1"
      );
      const container = document.getElementById("bbu");
      container.innerHTML = "";

      Object.keys(slotPositions).forEach(slotKey => {
        const pos = slotPositions[slotKey];
        const wrapper = document.createElement("div");
        wrapper.className = `slot s${slotKey}`;
        wrapper.style.gridColumnStart = pos.col;
        wrapper.style.gridRowStart = pos.row;
        if (pos.rowspan) wrapper.style.gridRowEnd = `span ${pos.rowspan}`;

        const content = document.createElement("div");
        content.className = "slot-content";

        const matches = devices.filter(d => String(parseUnitPosition(d["Unit Position"]).slot) === slotKey);
        if (matches.length) {
          const m = matches[0];
          content.innerText = `Rack=1 Slot=${slotKey}\n${m["Vendor Unit Type Name"] || ""}\nSN: ${m["Serial Number"] || ""}`;
          wrapper.classList.add("highlight");
        } else {
          content.innerText = `Slot ${slotKey} : empty`;
        }

        wrapper.appendChild(content);
        container.appendChild(wrapper);
      });
    }

    function renderRRUs(allDevices, label) {
      const rruDiv = document.getElementById("rrus");
      rruDiv.innerHTML = "";
      const rrus = allDevices.filter(d =>
        (d["Inventory Unit Type"] || "").toUpperCase() === "RRU" &&
        String(d["User Label"] || "").trim() === label
      );
      if (!rrus.length) return;
      const sectors = {};
      rrus.forEach(r => {
        const ul = r["User Label"] || "";
        const sectorMatch = ul.match(/S\d+/i);
        const sector = sectorMatch ? sectorMatch[0].toUpperCase() : "Kh√°c";
        if (!sectors[sector]) sectors[sector] = [];
        sectors[sector].push(r);
      });
      rruDiv.innerHTML = "<h3>RRUs</h3>";
      Object.keys(sectors).forEach(sec => {
        const secDiv = document.createElement("div");
        secDiv.className = "rru-sector";
        secDiv.innerHTML = `<h4>${sec}</h4>`;
        sectors[sec].forEach(r => {
          const pos = parseUnitPosition(r["Unit Position"]);
          const el = document.createElement("div");
          el.className = "rru highlight";
          el.innerText = `${r["User Label"] || "RRU"} (Rack=${pos.rack} Slot=${pos.slot}) ${r["Vendor Unit Type Name"] || ""} SN: ${r["Serial Number"] || ""}`;
          secDiv.appendChild(el);
        });
        rruDiv.appendChild(secDiv);
      });
    }

    function renderTable(allDevices, label) {
      const rows = allDevices.filter(d => String(d["User Label"] || "").trim() === label);
      if (!rows.length) {
        document.getElementById("deviceTable").innerHTML = "<p>Kh√¥ng c√≥ thi·∫øt b·ªã n√†o</p>";
        return;
      }
      const cols = Object.keys(rows[0]);
      let html = "<h3>Danh s√°ch thi·∫øt b·ªã</h3><table><thead><tr>";
      cols.forEach(c => html += `<th>${c}</th>`);
      html += "</tr></thead><tbody>";
      rows.forEach(r => {
        html += "<tr>";
        cols.forEach(c => html += `<td>${r[c] ?? ""}</td>`);
        html += "</tr>";
      });
      html += "</tbody></table>";
      document.getElementById("deviceTable").innerHTML = html;
    }

    async function loadData() {
      const label = getParam("label") || "";
      try {
        const response = await fetch("inventory.xlsx");
        if (!response.ok) throw new Error("Kh√¥ng t√¨m th·∫•y file inventory.xlsx");
        const buf = await response.arrayBuffer();
        const wb = XLSX.read(buf, { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet);
        renderBBU(data, label);
        renderRRUs(data, label);
        renderTable(data, label);
      } catch (e) {
        document.body.innerHTML += `<p style="color:red">‚ùå L·ªói: ${e.message}</p>`;
      }
    }
    loadData();
  </script>
</body>
</html>
