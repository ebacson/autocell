<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üì° S∆° ƒë·ªì BBU 8200</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    h2 { text-align: center; margin-bottom: 12px; }

    /* Khung BBU: c·ªë ƒë·ªãnh 1000px √ó 400px */
    .bbu {
      display: grid;
      grid-template-columns: 1fr 2fr 2fr 1fr; /* c·ªôt 1 nh·ªè, c·ªôt 2+3 l·ªõn, c·ªôt 4 nh·ªè */
      grid-template-rows: repeat(4, 1fr);     /* 4 h√†ng b·∫±ng nhau */
      gap: 8px;
      width: 1000px;
      height: 400px;
      margin: 0 auto 20px;
      background: #fff;
      padding: 18px;
      border: 3px solid #333;
      border-radius: 10px;
      box-sizing: border-box;
    }

    .slot {
      border: 2px solid #007bff;
      border-radius: 6px;
      background: #e9f3ff;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      white-space: pre-line;
      overflow: hidden;
      padding: 6px;
      box-sizing: border-box;
    }

    .slot .slot-content {
      width: 100%;
      text-align: center;
    }

    /* Slot 14 v√† 15 r·ªông g·∫•p 1.5 slot th∆∞·ªùng */
    .slot.s14, .slot.s15 {
      grid-column-end: span 2; /* chi·∫øm th√™m 1 c·ªôt */
    }

    /* Slot 16 h·∫πp h∆°n */
    .slot.s16 .slot-content {
      width: 50%;
      margin: 0 auto;
    }

    .highlight {
      background: #ffeb3b !important;
      border-color: #ff9800 !important;
      font-weight: bold;
    }

    /* responsive cho m√†n nh·ªè */
    @media (max-width: 720px) {
      .bbu { 
        grid-template-rows: repeat(8, 50px);
        grid-template-columns: 1fr 1fr;
        width: 100%;
        height: auto;
      }
      .slot.s16 { grid-column: 2; grid-row: 1 / span 8; }
      .slot.s14, .slot.s15 { grid-column-end: span 1; }
    }
  </style>
</head>
<body>
  <h2>üì° S∆° ƒë·ªì BBU 8200</h2>
  <div id="bbu" class="bbu" aria-label="BBU layout"></div>

  <script>
    function getParam(name) {
      try { const url = new URL(window.location.href); return url.searchParams.get(name); }
      catch (e) { return null; }
    }

    function parseUnitPosition(unitPos) {
      const obj = { rack: "", shelf: "", slot: "" };
      if (!unitPos) return obj;
      unitPos.split(',').forEach(p => {
        const parts = p.split('=');
        if (parts.length >= 2) {
          const key = parts[0].trim().toLowerCase();
          const value = parts.slice(1).join('=').trim();
          if (key && value) obj[key] = value;
        }
      });
      return obj;
    }

    // ƒë·ªãnh nghƒ©a v·ªã tr√≠ slot
    const slotPositions = {
      '15': { col: 1, row: 2 },
      '14': { col: 1, row: 3 },
      '13': { col: 1, row: 4 },

      '4':  { col: 2, row: 1 },
      '3':  { col: 2, row: 2 },
      '2':  { col: 2, row: 3 },
      '1':  { col: 2, row: 4 },

      '8':  { col: 3, row: 1 },
      '7':  { col: 3, row: 2 },
      '6':  { col: 3, row: 3 },
      '5':  { col: 3, row: 4 },

      '16': { col: 4, row: 1, rowspan: 4 }
    };

    function renderBBU(allDevices, label) {
      const devices = allDevices.filter(d =>
        String(d['User Label'] || '').trim() === label &&
        parseUnitPosition(d['Unit Position']).rack === '1'
      );

      const container = document.getElementById('bbu');
      container.innerHTML = '';

      const slotsOrder = Object.keys(slotPositions);

      slotsOrder.forEach(slotKey => {
        const pos = slotPositions[slotKey];
        if (!pos) return;

        const wrapper = document.createElement('div');
        wrapper.className = `slot s${slotKey}`;
        wrapper.style.gridColumnStart = pos.col;
        wrapper.style.gridRowStart = pos.row;
        if (pos.rowspan) wrapper.style.gridRowEnd = `span ${pos.rowspan}`;

        const content = document.createElement('div');
        content.className = 'slot-content';

        const matches = devices.filter(d => {
          const up = parseUnitPosition(d['Unit Position']);
          return String(up.slot) === String(slotKey);
        });

        if (matches.length) {
          const m = matches[0];
          content.innerText = `Rack=1 Slot=${slotKey}\n${m['Vendor Unit Type Name'] || ''}\nSN: ${m['Serial Number'] || ''}`;
          wrapper.classList.add('highlight');
        } else {
          content.innerText = `Slot ${slotKey} : empty`;
        }

        wrapper.appendChild(content);
        container.appendChild(wrapper);
      });
    }

    async function loadData() {
      const label = getParam('label') || '';
      if (!label) {
        document.body.insertAdjacentHTML('beforeend', '<p style="color:orange">‚ö†Ô∏è Vui l√≤ng cung c·∫•p param ?label=NAME trong URL ƒë·ªÉ l·ªçc theo User Label.</p>');
      }

      try {
        const resp = await fetch('inventory.xlsx');
        if (!resp.ok) throw new Error('Kh√¥ng t√¨m th·∫•y file inventory.xlsx (ƒë·∫∑t c√πng th∆∞ m·ª•c v·ªõi bbu.html)');

        const buf = await resp.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet);

        renderBBU(data, label);
      } catch (err) {
        document.body.insertAdjacentHTML('beforeend', `<p style="color:red">‚ùå L·ªói: ${err.message}</p>`);
      }
    }

    loadData();
  </script>
</body>
</html>
