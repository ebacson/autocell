<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Tra c·ª©u thi·∫øt b·ªã</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    h1 { color: #2c3e50; font-size: 20px; text-align: center; }
    .controls { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
    input, button { padding: 10px; font-size: 16px; width: 100%; box-sizing: border-box; }
    button { background: #3498db; color: #fff; border: none; border-radius: 4px; }
    button:hover { background: #2980b9; cursor: pointer; }
    .table-container { overflow-x: auto; }
    table { border-collapse: collapse; width: 100%; min-width: 600px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; font-size: 14px; }
    th { background: #f8f8f8; position: sticky; top: 0; }
    tr:nth-child(even) { background: #f2f2f2; }
  </style>
</head>
<body>
  <h1>Tra c·ª©u thi·∫øt b·ªã</h1>
  <div class="controls">
    <input type="text" id="searchSerial" placeholder="Nh·∫≠p Serial Number (ch√≠nh x√°c)">
    <input type="text" id="searchLabel" placeholder="Nh·∫≠p User Label (m·ªôt ph·∫ßn)">
    <button onclick="search()">üîç T√¨m</button>
    <button onclick="showAll()">üìã Hi·ªán t·∫•t c·∫£</button>
    <button onclick="downloadCSV()">‚¨áÔ∏è T·∫£i k·∫øt qu·∫£ (CSV)</button>
  </div>
  <div id="result"></div>

  <script>
    let data = [];
    let cols = [];

    // Load file Excel trong th∆∞ m·ª•c g·ªëc
    fetch("inventory.xlsx")
      .then(res => res.arrayBuffer())
      .then(ab => {
        const wb = XLSX.read(ab, {type: "array"});
        const ws = wb.Sheets[wb.SheetNames[0]];
        data = XLSX.utils.sheet_to_json(ws, {defval: ""});
        cols = Object.keys(data[0] || {});
        document.getElementById("result").innerHTML =
          `<p>ƒê√£ t·∫£i ${data.length} b·∫£n ghi t·ª´ <b>inventory.xlsx</b></p>`;
      });

    function renderTable(records) {
      if (records.length === 0) {
        document.getElementById('result').innerHTML = "<p><b>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</b></p>";
        return;
      }
      let html = '<div class="table-container"><table><thead><tr>';
      cols.forEach(c => html += "<th>" + c + "</th>");
      html += "</tr></thead><tbody>";
      records.forEach(r => {
        html += "<tr>";
        cols.forEach(c => html += "<td>" + (r[c] || '') + "</td>");
        html += "</tr>";
      });
      html += "</tbody></table></div>";
      document.getElementById('result').innerHTML = html;
    }

    function search() {
      const serial = document.getElementById('searchSerial').value.trim().toLowerCase();
      const label = document.getElementById('searchLabel').value.trim().toLowerCase();
      const filtered = data.filter(r => {
        let matchSerial = serial === "" || (r["Serial Number"] || "").toLowerCase() === serial; // ch√≠nh x√°c
        let matchLabel = label === "" || (r["User Label"] || "").toLowerCase().includes(label); // ch·ª©a
        return matchSerial && matchLabel;
      });
      renderTable(filtered);
    }

    function showAll() {
      renderTable(data.slice(0, 200)); // Gi·ªõi h·∫°n 200 d√≤ng
    }

    function downloadCSV() {
      const serial = document.getElementById('searchSerial').value.trim().toLowerCase();
      const label = document.getElementById('searchLabel').value.trim().toLowerCase();
      const filtered = data.filter(r => {
        let matchSerial = serial === "" || (r["Serial Number"] || "").toLowerCase() === serial;
        let matchLabel = label === "" || (r["User Label"] || "").toLowerCase().includes(label);
        return matchSerial && matchLabel;
      });
      if (filtered.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i.");
        return;
      }
      let csv = cols.join(",") + "\n";
      filtered.forEach(r => {
        let row = cols.map(c => `"${(r[c] || '').toString().replace(/"/g,'""')}"`).join(",");
        csv += row + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ket_qua.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>
</html>